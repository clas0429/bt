<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å³æ™‚å°è©±éŸ³ç®±</title>
    <style>
        body {
            font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            text-align: center;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        
        label { display: block; text-align: left; margin: 10px 0 5px 5%; color: #bdc3c7; font-size: 14px;}

        select {
            padding: 12px;
            font-size: 16px;
            border-radius: 10px;
            margin-bottom: 10px;
            width: 90%;
            border: none;
            background: #ecf0f1;
            color: #2c3e50;
        }

        .input-group { position: relative; width: 90%; margin: 0 auto; }
        textarea {
            width: 100%; height: 100px; padding: 15px; font-size: 18px;
            border-radius: 15px; border: none; resize: none; box-sizing: border-box;
        }
        .mic-btn {
            position: absolute; bottom: 10px; right: 10px;
            background-color: #3498db; border: none; border-radius: 50%;
            width: 50px; height: 50px; font-size: 24px; cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3); transition: 0.3s;
        }
        .mic-btn.listening { background-color: #e74c3c; animation: pulse 1.5s infinite; }
        
        /* ç™¼é€æŒ‰éˆ•é‚„æ˜¯ç•™è‘—ï¼Œä»¥é˜²ä½ æƒ³ç”¨æ‰“å­—çš„ */
        .btn-ask {
            width: 90%; padding: 15px; font-size: 20px; border: none;
            border-radius: 50px; cursor: pointer; margin-top: 20px;
            background-color: #27ae60; color: white; font-weight: bold;
            box-shadow: 0 4px 0 #219150;
        }
        .btn-ask:active { transform: translateY(4px); box-shadow: none; }
        
        #responseArea {
            margin-top: 20px; padding: 20px; background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px; text-align: left; min-height: 100px;
            line-height: 1.6; white-space: pre-wrap;
        }
        .status { color: #f1c40f; font-size: 14px; margin-top: 10px; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ—£ï¸ AI å³æ™‚å°è©±éŸ³ç®±</h1>
        
        <label>1. é¸æ“‡ AI å€‹æ€§</label>
        <select id="aiTone">
            <option value="normal">ğŸ¤– æ­£å¸¸åŠ©ç†</option>
            <option value="kindergarten">ğŸ§¸ å¹¼å…’åœ’è€å¸«</option>
            <option value="humorous">ğŸ¤£ å¹½é»˜æç¬‘å’–</option>
            <option value="tsundere">ğŸ˜¤ å‚²å¬Œæ©Ÿå™¨äºº</option>
            <option value="gangster">ğŸ˜ æ±Ÿæ¹–å¤§å“¥</option>
        </select>

        <label>2. é¸æ“‡èªªè©±è²éŸ³</label>
        <select id="voiceSelect">
            <option value="">è®€å–è²éŸ³ä¸­...</option>
        </select>

        <div class="input-group">
            <textarea id="userInput" placeholder="é»æ“Šå³ä¸‹è§’éº¥å…‹é¢¨ï¼Œèªªå®Œè‡ªå‹•ç™¼é€..."></textarea>
            <button class="mic-btn" id="micBtn" onclick="toggleSpeech()">ğŸ¤</button>
        </div>
        
        <button class="btn-ask" onclick="askGemini()">ğŸš€ æ‰‹å‹•ç™¼é€ (æ‰“å­—ç”¨)</button>
        
        <div id="statusText" class="status"></div>
        <div id="responseArea">ç­‰å¾…å°è©±ä¸­...</div>
    </div>

    <script>
        // ğŸ”´ è«‹åœ¨é€™è£¡è²¼ä¸Šä½  æ–°çš„ API Key
        const API_KEY = "AIzaSyBR89k--Pp9VjXHSLDLuBkS3x41OS4lfPg"; 

        // --- 1. è²éŸ³è¼‰å…¥ ---
        let voices = [];
        const voiceSelect = document.getElementById("voiceSelect");
        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
            voiceSelect.innerHTML = "";
            const chineseVoices = voices.filter(voice => voice.lang.includes('zh'));
            (chineseVoices.length > 0 ? chineseVoices : voices).forEach((voice, index) => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = index; // æš«å­˜ç´¢å¼•ï¼Œä½†ä¸‹é¢æœƒé‡æ–°å°æ‡‰
                // é€™è£¡çš„å°æŠ€å·§ï¼šæŠŠçœŸæ­£çš„ voice ç‰©ä»¶å­˜åˆ° select çš„å±¬æ€§è£¡æ¯”è¼ƒä¿éšªï¼Œ
                // ä½†ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘ä¸‹é¢ speakOut é‚„æ˜¯ç”¨ filter æ‰¾æ¯”è¼ƒç©©
                voiceSelect.appendChild(option);
            });
            if (voiceSelect.options.length === 0) voiceSelect.innerHTML = "<option>é è¨­è²éŸ³</option>";
        }
        speechSynthesis.onvoiceschanged = loadVoices;
        loadVoices();

        // --- 2. èªéŸ³è¾¨è­˜ (å«è‡ªå‹•ç™¼é€é‚è¼¯) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.interimResults = true;
            recognition.continuous = false; // è¬›å®Œä¸€å¥è‡ªå‹•åœ

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById("userInput").value = transcript;
            };

            // ğŸ›‘ é—œéµä¿®æ”¹ï¼šç•¶èªéŸ³çµæŸæ™‚ (onend)
            recognition.onend = function() {
                isListening = false;
                document.getElementById("micBtn").classList.remove("listening");
                
                // æª¢æŸ¥è¼¸å…¥æ¡†è£¡é¢æœ‰æ²’æœ‰å­—
                const text = document.getElementById("userInput").value;
                
                if (text && text.trim().length > 0) {
                    // ğŸ‰ å¦‚æœæœ‰å­—ï¼Œå°±è‡ªå‹•åŸ·è¡Œç™¼é€ï¼
                    document.getElementById("statusText").innerText = "ğŸš€ èªªå®Œäº†ï¼Œè‡ªå‹•ç™¼é€ä¸­...";
                    askGemini(); 
                } else {
                    document.getElementById("statusText").innerText = "ğŸ¤ æ²’è½åˆ°è²éŸ³ï¼Œè«‹å†æŒ‰ä¸€æ¬¡";
                }
            };

            recognition.onerror = function(event) {
                console.error(event);
                isListening = false;
                document.getElementById("micBtn").classList.remove("listening");
                document.getElementById("statusText").innerText = "âŒ èªéŸ³è¾¨è­˜éŒ¯èª¤";
            };
        }

        function toggleSpeech() {
            if (!recognition) { alert("ç€è¦½å™¨ä¸æ”¯æ´"); return; }
            if (isListening) {
                recognition.stop(); // æ‰‹å‹•æŒ‰åœæ­¢ä¹Ÿæœƒè§¸ç™¼ onend -> è‡ªå‹•ç™¼é€
            } else {
                // æ¸…ç©ºæ–‡å­—æ¡†ï¼Œæº–å‚™æ”¶éŸ³
                document.getElementById("userInput").value = "";
                recognition.start();
                isListening = true;
                document.getElementById("micBtn").classList.add("listening");
                document.getElementById("statusText").innerText = "ğŸ‘‚ æ­£åœ¨è½...";
            }
        }

        // --- 3. AI å°è©± (åŠ é€Ÿç‰ˆ) ---
        async function askGemini() {
            const inputText = document.getElementById("userInput").value;
            if (!inputText) return; // æ²’å­—å°±ä¸é€

            const tone = document.getElementById("aiTone").value;
            const statusDiv = document.getElementById("statusText");
            const responseDiv = document.getElementById("responseArea");

            statusDiv.innerText = "âš¡ AI å…‰é€Ÿæ€è€ƒä¸­...";
            responseDiv.innerText = "Loading...";

            // è§’è‰²è¨­å®š
            let toneInstruction = "ç°¡çŸ­å£èªåŒ–å›ç­”";
            if(tone === "kindergarten") toneInstruction = "æ‰®æ¼”æº«æŸ”å¹¼å…’åœ’è€å¸«ï¼Œç”¨ç–Šå­—";
            if(tone === "humorous") toneInstruction = "æ‰®æ¼”å¹½é»˜æç¬‘å’–ï¼Œè¦æœ‰æ¢—";
            if(tone === "tsundere") toneInstruction = "æ‰®æ¼”å‚²å¬Œæ©Ÿå™¨äººï¼Œå¸¸ç”¨'å“¼'";
            if(tone === "gangster") toneInstruction = "æ‰®æ¼”æ±Ÿæ¹–å¤§å“¥ï¼Œè¬›ç¾©æ°£";

            const prompt = `${toneInstruction} (é™50å­—å…§ï¼Œå£èª)ã€‚å•ï¼š${inputText}`;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { maxOutputTokens: 100 } // åŠ é€Ÿé™åˆ¶
                    })
                });

                const result = await response.json();
                if (result.error || !result.candidates) throw new Error("ç„¡å›æ‡‰");

                const aiText = result.candidates[0].content.parts[0].text;
                statusDiv.innerText = "âœ… å®Œæˆ";
                responseDiv.innerText = aiText;
                speakOut(aiText);

            } catch (error) {
                console.error(error);
                statusDiv.innerText = "âŒ å¤±æ•—";
                responseDiv.innerText = "é€£ç·šå•é¡Œ";
            }
        }

        // --- 4. TTS æœ—è®€ ---
        function speakOut(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            
            // æŠ“å–ç›®å‰é¸å–®é¸åˆ°çš„è²éŸ³
            const selectedIndex = voiceSelect.selectedIndex;
            // é‡æ–°æŠ“ä¸€æ¬¡è²éŸ³åˆ—è¡¨ (å› ç‚ºæœ‰äº›ç€è¦½å™¨ä¸è®“ voiceSelect ç›´æ¥å­˜ç‰©ä»¶)
            const currentVoices = window.speechSynthesis.getVoices();
            // å…ˆéæ¿¾å‡ºä¸­æ–‡
            const chineseVoices = currentVoices.filter(v => v.lang.includes('zh'));
            const targetList = chineseVoices.length > 0 ? chineseVoices : currentVoices;
            
            if (targetList[selectedIndex]) {
                utterance.voice = targetList[selectedIndex];
            }

            // èªé€Ÿå¾®èª¿
            utterance.rate = 1.0;
            const tone = document.getElementById("aiTone").value;
            if (tone === "kindergarten") utterance.rate = 0.85;
            if (tone === "humorous") utterance.rate = 1.1;

            window.speechSynthesis.speak(utterance);
        }
    </script>

</body>
</html>
